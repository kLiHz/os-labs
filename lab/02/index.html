<!DOCTYPE HTML>
<html lang="zh-cn" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>实验二：进程的初步认识 - OS Labs</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/css/custom-style.css">
        <link rel="stylesheet" href="../../theme/css/custom-font.css">
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">首页</a></li><li class="chapter-item expanded "><a href="../../lab/index.html"><strong aria-hidden="true">1.</strong> 操作系统实验</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../lab/01/index.html"><strong aria-hidden="true">1.1.</strong> 实验一：Linux 的初步认识</a></li><li class="chapter-item expanded "><a href="../../lab/02/index.html" class="active"><strong aria-hidden="true">1.2.</strong> 实验二：进程的初步认识</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OS Labs</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/tsagaanbar/os-labs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/tsagaanbar/os-labs/edit/main/src/lab/02/README.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="实验二进程的初步认识"><a class="header" href="#实验二进程的初步认识">实验二：进程的初步认识</a></h1>
<p>实验课时：3 学时</p>
<h2 id="一实验目的"><a class="header" href="#一实验目的">一、实验目的</a></h2>
<ol>
<li>熟练使用系统调用：<code>fork</code>、<code>getpid</code>、<code>getppid</code>、<code>execvp</code>；</li>
<li>设计程序，实现结果的不可再现性；使用同步原语，实现结果的可再现性；</li>
<li>设计程序，使用递归及非递归方法对系统的进程数目进行压力测试，对运行时间进行监控。</li>
</ol>
<!-- 备注：使用同步原语，实现结果的可再现性：采用wait,semop。备注文字不写入实验报告 -->
<h2 id="二实验原理"><a class="header" href="#二实验原理">二、实验原理</a></h2>
<h3 id="1-简单的系统调用"><a class="header" href="#1-简单的系统调用">1. 简单的系统调用</a></h3>
<h4 id="fork"><a class="header" href="#fork">fork()</a></h4>
<p><code>fork</code> 是符合 POSIX 要求的系统调用，在大多数类 Unix 系统上都可以使用。它可以用来创建新的进程，这个新的进程称作<strong>子进程</strong>（Child）。相对的，<code>fork</code> 的调用者（Caller）就称为父进程（Parent）。子进程是父进程的一份拷贝，也就是说，两个进程的数据段和代码段是相同的（但是不共享这些存储空间），当前执行的代码位置也是一样的，当子进程创建完成后，两个进程都会执行 <code>fork</code> 之后的代码。</p>
<p>通过 <code>fork</code> 调用，可以实现程序的并发运行，也可以运行文件系统中的其他可执行程序。</p>
<blockquote>
<p>事实上，内核在进行进程的拷贝时，采用的是 Copy-On-Write 的方式，即只在发生写入时才真正进行数据的拷贝。</p>
<ul>
<li><code>fork()</code> 和 <code>CreateProcess()</code> 的区别：<a href="https://stackoverflow.com/questions/13839935/forking-and-createprocess">https://stackoverflow.com/questions/13839935/forking-and-createprocess</a></li>
<li>为什么要通过 fork 来创建新的进程：<a href="https://unix.stackexchange.com/questions/136637/why-do-we-need-to-fork-to-create-new-processes/136649#136649">https://unix.stackexchange.com/questions/136637/why-do-we-need-to-fork-to-create-new-processes/136649#136649</a></li>
</ul>
</blockquote>
<p><code>fork()</code> 不接收参数，而在两个进程中均返回一个值：如果进程创建成功，则在父进程中返回子进程的 PID 值，在子进程中返回 0；否则，在父进程中返回 -1。</p>
<pre><code class="language-cpp">pid_t fork(void);
</code></pre>
<p>示例程序 <a href="./fork-demo.cpp">fork-demo.cpp</a></p>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;sys/wait.h&gt;
#include &lt;unistd.h&gt;

int main() {
    pid_t child_pid = fork();

    if (child_pid == -1) {
        perror(&quot;fork&quot;);
        exit(EXIT_FAILURE);
    } else if (child_pid &gt; 0) {
        std::cout &lt;&lt; &quot;printed from parent process &quot; &lt;&lt; getpid() &lt;&lt; std::endl;
        wait(nullptr);
    } else {
        std::cout &lt;&lt; &quot;printed from child process &quot; &lt;&lt; getpid() &lt;&lt; std::endl;
        exit(EXIT_SUCCESS);
    }

    return EXIT_SUCCESS;
}
</code></pre>
<p>程序的输出类似如下：</p>
<pre><code>printed from parent process 705
printed from child process 706
</code></pre>
<p><img src="assets/fork-demo.svg" alt="fork 示例程序的运行结果的终端示意图" /></p>
<p>需要注意，程序每次执行的结果可能都会不一样，并不能保证子进程和父进程执行的先后顺序；此外，每次执行时进程的 PID 也不尽相同。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://www.csl.mtu.edu/cs4411.ck/www/NOTES/process/fork/create.html">https://www.csl.mtu.edu/cs4411.ck/www/NOTES/process/fork/create.html</a></li>
</ul>
<h4 id="wait"><a class="header" href="#wait">wait()</a></h4>
<p>调用了 <code>wait()</code> 的进程将一直被阻塞，直到其中一个子进程退出，或者接收到相应的信号。<code>wait()</code> 接收一个 <code>int</code> 类型变量的地址作为参数，而将返回完成了的子进程的参数。表示子进程的完成状态的标志将写入传入的 <code>int</code> 类型指针所指向的地址。</p>
<p><code>wait()</code> 的执行有两种可能的情况：</p>
<ul>
<li>如果调用 <code>wait()</code> 时，有至少一个子进程正在运行，则调用者将被阻塞直至某一子进程退出，之后，调用者继续执行后续代码。</li>
<li>如果调用 <code>wait()</code> 时没有子进程正在运行，则该次调用不产生影响。</li>
</ul>
<p>考虑下面的程序：</p>
<p><a href="./wait-demo.c">wait-demo.c</a></p>
<pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;
#include &lt;unistd.h&gt;

#define MAX_COUNT   100
#define BUF_SIZE    100

void ChildProcess(char[], char[]); /* child process declare */

int main(void)
{
    pid_t     pid1, pid2, pid;
    int       status;
    int       i;
    char      buf[BUF_SIZE];

    printf(&quot;*** Parent is about to fork process 1 ***\n&quot;);

    pid1 = fork();
    if (pid1 &lt; 0) {
        printf(&quot;Failed to fork process 1\n&quot;);
        return 1;
    } else if (pid1 == 0) {  /* In Child Process */
        ChildProcess(&quot;First&quot;, &quot;   &quot;);
        return 0;
    }

    printf(&quot;*** Parent is about to fork process 2 ***\n&quot;);

    pid2 = fork();
    if (pid2 &lt; 0) {
        printf(&quot;Failed to fork process 2\n&quot;);
        return 1;
    } else if (pid2 == 0) {
        ChildProcess(&quot;Second&quot;, &quot;      &quot;);
        return 0;
    }

    /* The parent process can do something else. */

    sprintf(buf, &quot;*** Parent enters waiting status .....\n&quot;);
    write(1, buf, strlen(buf));

    pid = wait(&amp;status);
    sprintf(buf, &quot;*** Parent detects process %d was done ***\n&quot;, pid);
    write(1, buf, strlen(buf));

    pid = wait(&amp;status);
    printf(&quot;*** Parent detects process %d is done ***\n&quot;, pid);

    printf(&quot;*** Parent exits ***\n&quot;);
    return 0;
}

/* Child Process's Code */
void ChildProcess(char *number, char *space)
{
    pid_t pid;
    int i;
    char buf[BUF_SIZE];

    pid = getpid();
    sprintf(buf, &quot;%s%s child process starts (pid = %d)\n&quot;,
           space, number, pid);
    write(1, buf, strlen(buf));

    for (i = 1; i &lt;= MAX_COUNT; i++) {
        sprintf(buf, &quot;%s%s child's output, value = %d\n&quot;, space, number, i);
        write(1, buf, strlen(buf));
    }

    sprintf(buf, &quot;%s%s child (pid = %d) is about to exit\n&quot;,
           space, number, pid);
    write(1, buf, strlen(buf));
}
</code></pre>
<p>程序中通过两次 <code>fork</code> 调用创建了两个子进程，因此需要两次 <code>wait</code> 以等待子进程执行完毕。</p>
<p>需要注意的是，由于两个进程并发执行，我们无从得知某个进程会先于另一个结束运行，因此等待某一个特定的进程完成任务可能会导致“忙等（busy-waiting）”的现象出现。</p>
<ul>
<li><a href="http://www.csl.mtu.edu/cs4411.ck/www/NOTES/process/fork/wait.html">http://www.csl.mtu.edu/cs4411.ck/www/NOTES/process/fork/wait.html</a></li>
</ul>
<h4 id="execvp"><a class="header" href="#execvp">execvp()</a></h4>
<p>创建出的子进程并不一定要和父进程执行相同的代码。诸 <code>exec</code> 系统调用即是用来使一进程得以运行任意的程序文件，包括二进制可执行程序或 shell 脚本。</p>
<p><code>execvp()</code> 调用执行后，由第一个参数（<code>char *</code>）指定的程序文件，将被加载入调用者的地址空间，覆盖掉原有的程序代码；第二个参数指定的参数数组（<code>char **</code>）将被传递给该程序。</p>
<p>如果执行失败，<code>execvp()</code> 将返回一个负值。</p>
<p>我们可以实现一个简单的 shell 程序（或者说，一个能够根据用户从终端输入的字符串启动其他程序的程序）。</p>
<ul>
<li><a href="http://www.csl.mtu.edu/cs4411.ck/www/NOTES/process/fork/exec.html">http://www.csl.mtu.edu/cs4411.ck/www/NOTES/process/fork/exec.html</a></li>
</ul>
<h2 id="三实验内容"><a class="header" href="#三实验内容">三、实验内容</a></h2>
<h3 id="1-进程执行先后顺序的不可再现"><a class="header" href="#1-进程执行先后顺序的不可再现">1. 进程执行先后顺序的不可再现</a></h3>
<p>简单的 C 程序，从 CLI 参数读入对应的参数（序号），对应的序号参数由父进程通过 <code>execvp</code> 调用时传入；程序会将调用时传入的序号输出。</p>
<pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;

int main(int argc, char* argv[]) {
    printf(&quot;Process %s has start!\n&quot;, argv[1]);
    sleep(3);
    printf(&quot;Process %s finished!\n&quot;, argv[1]);
    return 0;
}
</code></pre>
<p>另一 C 程序，通过 fork 调用创建子进程，执行该程序。</p>
<pre><code class="language-cpp">#include &lt;unistd.h&gt;
#include &lt;sys/wait.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdio.h&gt;

int main()
{
    int status;
    char *const argv1[] = {&quot;./print&quot;, &quot;1&quot;, NULL};
    char *const argv2[] = {&quot;./print&quot;, &quot;2&quot;, NULL};
    char *const argv3[] = {&quot;./print&quot;, &quot;3&quot;, NULL};
    char *const argv4[] = {&quot;./print&quot;, &quot;4&quot;, NULL};

    pid_t pid[3];

    pid[0] = fork();
    if (pid[0] == 0) {
        execvp(argv1[0], argv1);
        // 根据 execvp 的行为，以下语句不会被执行
        sleep(1);
        execvp(argv2[0], argv2);
        sleep(1);
    }

    pid[1] = fork();
    if (pid[1] == 0) {
        execvp(argv3[0], argv3);
        sleep(1);
    }

    pid[2] = fork();
    if (pid[2] == 0) {
        execvp(argv4[0], argv4);
        sleep(1);
    }

    wait(&amp;status);
    wait(&amp;status);
    wait(&amp;status);

    printf(&quot;Main process finished.\n&quot;);
}
</code></pre>
<p>结果图</p>
<p><img src="./assets/order-not-sure.png" alt="" /></p>
<p>可以看到两次执行的先后顺序不同。</p>
<h3 id="2-使用-wait-保证进程执行顺序"><a class="header" href="#2-使用-wait-保证进程执行顺序">2. 使用 wait 保证进程执行顺序</a></h3>
<p>使用 wait 即可使进程按顺序执行。</p>
<pre><code class="language-cpp">#include &lt;unistd.h&gt;
#include &lt;sys/wait.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdio.h&gt;

int main()
{
    int status;
    char *const argv1[] = {&quot;./print&quot;, &quot;1&quot;, NULL};
    char *const argv2[] = {&quot;./print&quot;, &quot;2&quot;, NULL};
    char *const argv3[] = {&quot;./print&quot;, &quot;3&quot;, NULL};
    char *const argv4[] = {&quot;./print&quot;, &quot;4&quot;, NULL};

    pid_t pid[3];

    pid[0] = fork();
    if (pid[0] == 0) {
        execvp(argv1[0], argv1);
        sleep(1);
    }
    wait(&amp;status);

    pid[1] = fork();
    if (pid[1] == 0) {
        execvp(argv3[0], argv3);
        sleep(1);
    }
    wait(&amp;status);

    pid[2] = fork();
    if (pid[2] == 0) {
        execvp(argv4[0], argv4);
        sleep(1);
    }
    wait(&amp;status);

    printf(&quot;Main process finished.\n&quot;);
}
</code></pre>
<p><img src="./assets/order-sure.png" alt="" /></p>
<h3 id="3-测试进程最大数目"><a class="header" href="#3-测试进程最大数目">3. 测试进程最大数目</a></h3>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../lab/01/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../lab/01/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
